document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".ad-map").forEach(e=>{const t=e.querySelectorAll(".ad-map__locations__item"),a=e.querySelectorAll(".ad-map__address__panel"),o=e.querySelector(".ad-map__map"),n=e.querySelector(".ad-map__container")?.classList.contains("is-single-map");let l=e.querySelectorAll(".ad-map__map__panel");const r=e.querySelector(".ad-map__leaflet"),i=e=>{t.forEach((t,a)=>t.classList.toggle("is-active",a===e)),a.forEach((t,a)=>t.classList.toggle("is-active",a===e))};let s=null,c=[],d=!1;const m=e.querySelector(".ad-map__container"),u=m?.getAttribute("data-fly-duration"),p=Math.max(.1,parseFloat(u||"0.9")||.9),f=()=>Array.from(t).map(e=>{const t=e.getAttribute("data-lat"),a=e.getAttribute("data-lng"),o=e.textContent?.trim()||"";return t&&a?{lat:parseFloat(t),lng:parseFloat(a),title:o}:null}),y=async e=>{if(!n||!r)return!1;if(d&&s)return!0;const t=f().filter(Boolean);if(!t.length)return!1;try{const a=await new Promise(e=>{if(window.L&&window.L.map)return e(window.L);const t="leaflet-css",a="leaflet-js";if(!document.getElementById(t)){const e=document.createElement("link");e.id=t,e.rel="stylesheet",e.href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css",document.head.appendChild(e)}const o=()=>e(window.L);if(document.getElementById(a))return window.L?o():void document.getElementById(a).addEventListener("load",o,{once:!0});const n=document.createElement("script");n.id=a,n.src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js",n.onload=o,document.head.appendChild(n)});if(!a||!a.map)return!1;if(!s){s=a.map(r,{zoomControl:!0,attributionControl:!0});const o=t[Math.max(0,e||0)]||t[0],n="https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png";a.tileLayer(n,{maxZoom:20,subdomains:"abcd"}).addTo(s),s.setView([o.lat,o.lng],16),c=t.map(e=>a.marker([e.lat,e.lng]).addTo(s).bindPopup(e.title))}return new Promise(e=>{s?s.whenReady(()=>{d=!0,e(!0)}):e(!1)})}catch(e){return console.error("Leaflet initialization error:",e),!1}},_=t=>{n?(async t=>{i(t);const a=f();if(a.some(e=>null!==e)){if(!(d&&s||await y(t)))return void console.error("Failed to initialize Leaflet map");if(s&&s.flyTo){const e=a[t];if(e&&"number"==typeof e.lat&&"number"==typeof e.lng)try{const a=s.getZoom(),o=Math.max(a,16);s.flyTo([e.lat,e.lng],o,{duration:p});const n=c[t];return void(n&&n.openPopup&&setTimeout(()=>n.openPopup(),Math.min(800,700*p)))}catch(e){console.error("FlyTo error:",e)}}}else{const a=e.querySelector(".ad-map__map__panel iframe"),n=Array.from(e.querySelectorAll(".ad-map__map__panel")).map(e=>e.querySelector("iframe")?.getAttribute("src")).filter(Boolean)[t]||"";a&&n&&(o?.classList.add("is-sliding"),a.setAttribute("src",n),setTimeout(()=>o?.classList.remove("is-sliding"),380))}})(t):(e=>{i(e),l.forEach((t,a)=>t.classList.toggle("is-active",a===e))})(t)};t.forEach((e,t)=>{e.addEventListener("click",()=>_(t))});const g=[...t].findIndex(e=>e.classList.contains("is-active")),h=g>=0?g:0;n?y(h).then(e=>{e?setTimeout(()=>_(h),100):_(h)}):_(h)})});